<html>
<head>
  <!--https://github.com/jamis/csmazes/tree/master
  https://stackoverflow.com/questions/38502/whats-a-good-algorithm-to-generate-a-maze-->
  <title>Maze Game</title>
  <link rel="stylesheet" type="text/css" href="css/mazes.css" />
  
  <!--jQuery, Popper.js, Bootstrap.js-->
  <script src="https://code.jquery.com/jquery-3.7.0.js" integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>        
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>        
  
  <!-- BOOTSTRAP -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">        
        
  <script src="maze.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script type="text/javascript">
    function resetMazes() {
      for(var i = 0; i < arguments.length; i++) {
        var id = arguments[i];
        var element = document.getElementById(id);
        element.mazeReset();
      }
    }
  </script>

  <style type="text/css">
    img {
      vertical-align:unset;
      pointer-events: none;
    }

    p {
      margin: 10px 20px;
    }

    small {
      color: #777;
      font-size: 11px;
    }

    input { width: 50%; }
  </style>
</head>
<body>
  <div id="bg-container">        
  </div>

  <div id="start-overlay" class="container-fluid">
    <div class="container">
      <div class="row">
        <h1>Choose your playstyle</h1>
      </div>
      
      <div class="row">
        <div class="btn-group-vertical" id="gamemode">
          <input type="radio" class="btn-check" name="btnradio" id="keyboard" autocomplete="off" value='1' checked>
          <label class="btn btn-outline-primary" for="keyboard">Keyboard</label>
        
          <input type="radio" class="btn-check" name="btnradio" id="voice" value='2' autocomplete="off">
          <label class="btn btn-outline-primary" for="voice">Voice control</label>
        </div>
      </div>
      <script> 
        $('#keyboard').on('click', () => {
          $('#keyboard-tutorial').css({'display':'block'});
          $('#voice-tutorial').css({'display':'none'});
        });
        
        $('#voice').on('click', () => {
          $('#keyboard-tutorial').css({'display':'none'});
          $('#voice-tutorial').css({'display':'block'});
        }) 
      </script>
      <div class="row" style="margin-top:1em">
          <div id="keyboard-tutorial">
            <h2>Tutorial: </h2>
            <h4>Use WASD to control your character through maze</h4>
          </div>
          <div id="voice-tutorial" style="display:none">
            <h2>Tutorial: </h2>
            <h4>Control your character by saying 'up', 'down', 'left', 'right' while pressing 
              <img src="Assets/Microphone.png" style="image-rendering: pixelated; border: 1px black solid">
              button </h4>
          </div>
      </div>
  
  
      <div class="row">
        <button type="button" id='start' class="btn btn-outline-primary btn-lg">Enter the maze !</button>
      </div>
    </div>
  </div>

  <div id="countdown-overlay" class="container-fluid">
    <h1>3</h1>
  </div>

  <div id="end-overlay" class="container-fluid">
    <h1>Game over !</h1> <br>
    <h2> You have earned <span id="point">0</span> coins</h2>

    <div id="scoreboard">

    </div>

    <div class="row">
      <button type="button" id="retry" class="btn btn-outline-primary btn-lg" >Retry !</button>
    </div>

    <div class="row">
      <button type="button" id="menu" class="btn btn-outline-primary btn-lg" >Main Menu</button>
    </div>
  </div>


  <div id='game-container' class="container">
    <div id="header-container" class="row">
      <div class="col-4"><h1 style="font-size: 2em;">Escape the maze!</h1></div>
      <div class="col-4"><h1 style="font-size: 2em;" id="time">10 seconds</h1></div>
      <div class="col-4"><h1 style="font-size: 2em;" id="coin">0</h1></div>
    </div>
    
    <div id="maze-container">
      <script type="text/javascript">
        var mazeSize = 7;
        Maze.createWidget("Kruskal", mazeSize, mazeSize, { "class": "small", "watch": false });
      </script>
    </div>

    <div id="footer-container">
      <h1>Escape the maze!</h1>

    </div>
  </div>

</body>
<script>
    var currentX = 0;
    var currentY = 0;
    var time = 10;

    var gameState = 0;
    var coin = 0;

    $('#retry').on('click', () => {
      window.location.reload(true);
    });
    $('#menu').on('click', () => {
      window.location.replace("/");
    });
    $('#start').on('click', () => {
      let gamemode = $('#gamemode input:radio:checked').val();

      $('#start-overlay').css({'display':'none'});
      $('#countdown-overlay').css({'display':'flex'});
      let count = 2
      let countdown = setInterval(() => {
        if(count <= 0) {
          clearInterval(countdown);
          $('#countdown-overlay').css({'display':'none'});

          let gameTime = setInterval(() => {
            $('#point').html(coin);
            (time <= 0) 
            ? $('#end-overlay').css({'display': 'flex'})
            : $('#time').html(`${time} seconds`); time--;

          }, 1000);
        } else {
          $('#countdown-overlay > h1').html(count);
          count--
        }
      }, 1000);

      switch (gamemode) {
        case '1':
          break;
        case '2':
          break;
      }
    });

    $(document).ready(function(){
        document.getElementById('kruskal').mazeRun(); 

        for (let i = 0; i < mazeSize ; i ++) {
          for (let j = 0; j < mazeSize ; j ++) {
            if(i != 0 || j != 0) $(`#kruskal_y${i}x${j}`).append('<img src="coin-nobg.gif" style="height:100%; image-rendering: pixelated; padding-top:1px; object-fit:scale-down">')
          }
        }
        let gridSize = (window.innerHeight > window.innerWidth) ? $('#maze-container').width() :  $('#maze-container').height();
        $('#kruskal_y0x0').append('<img src="cat-idle-nobg.gif" style="height:100%; image-rendering: pixelated; padding-top:1px">')
        $('.small .grid .box > div').css({'width': `${gridSize / mazeSize}px`, 'height': `${gridSize / mazeSize}px`})
        $(document).keydown(function(event){
            // event.which is deprecated, event.key is the modern approach
            var keyPressed = event.key; // Get the key that was pressed
            var element = document.getElementById(`kruskal_y${currentY}x${currentX}`);

            if (event.key == 'w' || event.key == 'W') {

              if(element.classList.contains('n')) {
                $(`#kruskal_y${currentY}x${currentX}`).empty()
                currentY -= 1;
                updateMaze();
              
              } else {
                console.log('blocked');
              }

            } else if (event.key == 'a' || event.key == 'A') {

              if(element.classList.contains('w')) {
                $(`#kruskal_y${currentY}x${currentX}`).empty()
                currentX -= 1;
                updateMaze();

              } else {
                console.log('blocked');
              }

            } else if (event.key == 's' || event.key == 'S') {

              if(element.classList.contains('s')) {
                $(`#kruskal_y${currentY}x${currentX}`).empty()
                currentY += 1;
                updateMaze();
              
              } else {
                console.log('blocked');
              }

            } else if (event.key == 'd' || event.key == 'D') {

              if(element.classList.contains('e')) {
                $(`#kruskal_y${currentY}x${currentX}`).empty()
                currentX += 1;
                updateMaze();

               } else {
                console.log('blocked');
              }

            } 

            console.log("Key pressed: " + keyPressed);
        });
    });
    
    function updateMaze() {
      var divChildren = $(`#kruskal_y${currentY}x${currentX}`).children().length;
      if (divChildren > 0) { 
        coin++
        $('#coin').html(coin);
        $(`#kruskal_y${currentY}x${currentX}`).empty()
      }
      $(`#kruskal_y${currentY}x${currentX}`).append('<img src="cat-idle-nobg.gif" style="height:100%; image-rendering: pixelated; padding-top:1px;">')           
    }

</script>
</html>
